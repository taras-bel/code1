{% extends "base.html" %}

{% block title %}Сессия: {{ session.title }}{% endblock %}

{% block head_extra %}
    {{ super() }}
    <style>
        #editor {
            width: 100%;
            height: 100%;
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .chat-messages {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .file-item.active {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .output-pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: monospace;
            background-color: #212529;
            color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3 h-100">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="row h-100">
        <!-- Sidebar -->
        <div class="col-md-3 d-flex flex-column">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Сессия: {{ session.title }}</strong>
                    <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#sessionDetailsCollapse" aria-expanded="false" aria-controls="sessionDetailsCollapse">
                        Детали
                    </button>
                </div>
                <div class="collapse show" id="sessionDetailsCollapse">
                    <div class="card-body">
                        <p><strong>Владелец:</strong> {{ session.owner.username }}</p>
                        <p><strong>Видимость:</strong> {{ session.visibility }}</p>
                        <p><strong>Язык по умолчанию:</strong> {{ session.language }}</p>
                        <p><strong>Описание:</strong> {{ session.description or 'Нет' }}</p>
                        <p><strong>ID сессии:</strong> <span id="sessionIdDisplay">{{ session.id }}</span> 
                            <button class="btn btn-sm btn-outline-secondary" onclick="copySessionId()">Копировать</button>
                        </p>
                        {% if current_user_role == 'owner' %}
                            <hr>
                            <h6 class="card-subtitle mb-2 text-muted">Управление сессией:</h6>
                            <form action="{{ url_for('main.delete_session', session_id=session.id) }}" method="POST" onsubmit="return confirm('Вы уверены, что хотите удалить эту сессию?');" class="mb-2">
                                <button type="submit" class="btn btn-danger btn-sm w-100"><i class="fas fa-trash"></i> Удалить сессию</button>
                            </form>
                            <form id="lockEditingForm" action="{{ url_for('main.lock_editing', session_id=session.id) }}" method="POST" class="mb-2">
                                <button type="submit" class="btn btn-warning btn-sm w-100" {% if session.editing_locked %}disabled{% endif %}>
                                    <i class="fas fa-lock"></i> Заблокировать редактирование
                                </button>
                            </form>
                            <form id="unlockEditingForm" action="{{ url_for('main.unlock_editing', session_id=session.id) }}" method="POST" class="mb-2">
                                <button type="submit" class="btn btn-success btn-sm w-100" {% if not session.editing_locked %}disabled{% endif %}>
                                    <i class="fas fa-unlock"></i> Разблокировать редактирование
                                </button>
                            </form>
                            <a href="{{ url_for('main.manage_collaborators', session_id=session.id) }}" class="btn btn-info btn-sm w-100">
                                <i class="fas fa-users-cog"></i> Управление коллабораторами
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card mb-3 flex-grow-1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Файлы сессии</strong>
                    {% if current_user_role in ['owner', 'editor'] %}
                    <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#addFileModal">
                        <i class="fas fa-plus"></i> Добавить файл
                    </button>
                    {% endif %}
                </div>
                <ul class="list-group list-group-flush" id="fileList">
                    {% for file in files %}
                        <li class="list-group-item d-flex justify-content-between align-items-center {% if active_file and file.id == active_file.id %}active{% endif %} file-item"
                            data-file-id="{{ file.id }}" data-file-name="{{ file.name }}" data-file-language="{{ file.language }}">
                            <a href="#" class="text-decoration-none text-reset flex-grow-1">
                                {{ file.name }} <span class="badge bg-secondary">{{ file.language }}</span>
                                {% if file.is_main %}<span class="badge bg-success">Основной</span>{% endif %}
                            </a>
                            <div class="file-actions ms-2">
                                {% if current_user_role in ['owner', 'editor'] %}
                                    {% if not file.is_main %}
                                        <button type="button" class="btn btn-sm btn-outline-info set-main-file-btn" title="Сделать основным">
                                            <i class="fas fa-code"></i>
                                        </button>
                                    {% endif %}
                                    {% if files|length > 1 %}
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" title="Удалить файл">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </li>
                    {% else %}
                        <li class="list-group-item text-muted">В этой сессии пока нет файлов.</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="card">
                <div class="card-header">
                    <strong>Участники сессии</strong>
                </div>
                <ul class="list-group list-group-flush" id="participantsList">
                    {% for participant in participants %}
                        <li class="list-group-item d-flex align-items-center">
                            <span class="badge {% if participant.role == 'owner' %}bg-success{% elif participant.role == 'editor' %}bg-primary{% else %}bg-info{% endif %} me-2">
                                {{ participant.role }}
                            </span>
                            <strong>{{ participant.username }}</strong>
                            {% if participant.id == current_user.id %}<span class="ms-auto text-muted small">(Вы)</span>{% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Editor and Output -->
        <div class="col-md-9 d-flex flex-column">
            <div class="card mb-3 flex-grow-1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <strong id="activeFileName">{{ active_file.name if active_file else 'Нет активного файла' }}</strong>
                        <span id="currentUserRole" class="badge bg-info ms-2">Ваша роль: {{ current_user_role }}</span>
                        <span id="editingLockStatus" class="ms-2 {% if session.editing_locked %}text-danger{% else %}text-success{% endif %}">
                            ({{ 'Редактирование заблокировано' if session.editing_locked else 'Редактирование разблокировано' }})
                        </span>
                    </div>
                    <div class="d-flex align-items-center">
                        <select id="languageSelect" class="form-select form-select-sm me-2" style="width: auto;">
                            {% for key, lang in languages.items() %}
                                <option value="{{ key }}" {% if active_file and active_file.language == key %}selected{% endif %}>{{ lang.name }}</option>
                            {% endfor %}
                        </select>
                        {% if current_user_role in ['owner', 'editor'] %}
                            <button class="btn btn-success btn-sm" id="executeCodeBtn" {% if session.editing_locked %}disabled{% endif %}>
                                <i class="fas fa-play"></i> Выполнить код
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0 d-flex flex-column" style="min-height: 0;">
                    <textarea id="editor" 
                        data-session-id="{{ session.id }}" 
                        data-user-id="{{ current_user.id }}" 
                        data-username="{{ current_user.username }}"
                        data-user-role="{{ current_user_role }}"
                        data-editing-locked="{{ 'True' if session.editing_locked else 'False' }}"
                        data-initial-file-id="{{ active_file.id if active_file else '' }}"
                        {% if active_file %}data-initial-language="{{ active_file.language }}"{% endif %}
                        {% if session.editing_locked or current_user_role not in ['owner', 'editor'] %}readonly{% endif %}
                    >{{ active_file.content if active_file else '' }}</textarea>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">
                    <strong>Вывод</strong>
                </div>
                <div class="card-body p-2">
                    <pre id="outputContent" class="output-pre">{{ session.output }}</pre>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <strong>Чат</strong>
                </div>
                <div class="card-body">
                    <div id="chatMessages" class="chat-messages">
                        {% for message in chat_messages %}
                            <div class="chat-message mb-2">
                                <strong>{{ message.user.username }}</strong> 
                                <span class="text-muted small">{{ message.timestamp.strftime('%H:%M') }}</span>: 
                                {{ message.content }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="input-group mt-2">
                        <input type="text" id="chatInput" class="form-control" placeholder="Введите сообщение..." {% if session.editing_locked %}disabled{% endif %}>
                        <button class="btn btn-primary" id="sendMessageBtn" {% if session.editing_locked %}disabled{% endif %}>Отправить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add File Modal -->
<div class="modal fade" id="addFileModal" tabindex="-1" aria-labelledby="addFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFileModalLabel">Добавить новый файл</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.add_file', session_id=session.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="file_name" class="form-label">Имя файла (с расширением, например, script.py)</label>
                        <input type="text" class="form-control" id="file_name" name="file_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="file_language" class="form-label">Язык</label>
                        <select class="form-select" id="file_language" name="file_language" required>
                            {% for key, lang in languages.items() %}
                                <option value="{{ key }}">{{ lang.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить файл</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function copySessionId() {
        const sessionId = document.getElementById('sessionIdDisplay').textContent;
        navigator.clipboard.writeText(sessionId).then(() => {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.innerHTML = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">Успешно</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ID сессии скопирован: ${sessionId}
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        });
    }
</script>
{% endblock %}

{% block scripts_extra %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
{% endblock %}